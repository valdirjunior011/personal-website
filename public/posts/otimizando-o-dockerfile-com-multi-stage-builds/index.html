<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>
  Dockerfile using Multi-Stage Builds and Secure Images Â· Valdir Junior
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Valdir Junior">
<meta name="description" content="Otimizing Dockerfile with Multi-Stage Builds and Secure Images using Chainguard">
<meta name="keywords" content="devops, cloud, kubernetes, docker, linux, ansible, terraform, python, aws, azure">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Dockerfile using Multi-Stage Builds and Secure Images">
  <meta name="twitter:description" content="Otimizing Dockerfile with Multi-Stage Builds and Secure Images using Chainguard">

<meta property="og:url" content="http://localhost:1313/posts/otimizando-o-dockerfile-com-multi-stage-builds/">
  <meta property="og:site_name" content="Valdir Junior">
  <meta property="og:title" content="Dockerfile using Multi-Stage Builds and Secure Images">
  <meta property="og:description" content="Otimizing Dockerfile with Multi-Stage Builds and Secure Images using Chainguard">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-02T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-02-02T00:00:00+00:00">
    <meta property="article:tag" content="Docker">
    <meta property="article:tag" content="Multi-Stage Builds">
    <meta property="article:tag" content="Chainguard">
    <meta property="article:tag" content="SeguranÃ§a">




<link rel="canonical" href="http://localhost:1313/posts/otimizando-o-dockerfile-com-multi-stage-builds/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.css" media="screen">






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.css" media="screen">
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="http://localhost:1313/">
      Valdir Junior
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Publications</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/projects/">Experience</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/valdir-junior.pdf">Curriculum</a>
            </li>
          
        
        
          
          
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="/pt-br/posts/otimizando-o-dockerfile-com-multi-stage-builds/">ðŸ‡§ðŸ‡·</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="http://localhost:1313/posts/otimizando-o-dockerfile-com-multi-stage-builds/">
              Dockerfile using Multi-Stage Builds and Secure Images
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2024-02-02T00:00:00Z">
                February 2, 2024
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              3-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="/categories/devops/">DevOps</a>
      <span class="separator">â€¢</span>
    <a href="/categories/containers/">Containers</a>
      <span class="separator">â€¢</span>
    <a href="/categories/linux/">Linux</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/docker/">Docker</a>
    </span>
      <span class="separator">â€¢</span>
    <span class="tag">
      <a href="/tags/multi-stage-builds/">Multi-Stage Builds</a>
    </span>
      <span class="separator">â€¢</span>
    <span class="tag">
      <a href="/tags/chainguard/">Chainguard</a>
    </span>
      <span class="separator">â€¢</span>
    <span class="tag">
      <a href="/tags/seguran%C3%A7a/">SeguranÃ§a</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p><img src="https://media.licdn.com/dms/image/v2/D4E12AQFiVMmK1xCdPA/article-cover_image-shrink_600_2000/article-cover_image-shrink_600_2000/0/1693653766393?e=1758758400&amp;v=beta&amp;t=Bn7TSy9VPWrDtZ0sT9O2sPazDNEfMBP7Kwz8AT67IKw" alt=""></p>
<p>One of the challenges when working with Docker is creating images that are both size-efficient and secure. This article will show an option for optimizing your Dockerfile using Multi-Stage Builds and how the Chainguard tool can be used to ensure Docker image security.</p>
<hr>
<ul>
<li><strong>Optimization with Multi-Stage Builds</strong></li>
</ul>
<p>Multi-Stage Builds is an advanced Docker technique that allows you to create smaller, more efficient images. The basic idea is to split the image build into multiple stages, each with its own build environment. This is especially useful when you need to compile source code or perform other complex tasks during the image build process.</p>
<ul>
<li><strong>How Layers Work</strong></li>
</ul>
<p>Before diving into Multi-Stage Builds, itâ€™s important to understand how layers work in a Dockerfile. Each instruction in a Dockerfile creates a new layer in the image. Layers are cached, which means that if you donâ€™t change an instruction in the Dockerfile, Docker will reuse the cached layer, saving time and disk space.</p>
<p>However, each layer adds size to the final image. This is important because large images can be problematic in resource-constrained environments and can slow down distribution.</p>
<hr>
<ul>
<li><strong>Multi-Stage Build Example</strong></li>
</ul>
<p>A simple example of a Multi-Stage Build for a Node.js application:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="line"><span class="cl"><span class="c"># Stage 1: Build the application</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> node:14 as builder</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> package*.json ./<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> npm install<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> npm run build<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Stage 2: Create a smaller final image</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> nginx:alpine</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /app/build /usr/share/nginx/html<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 80</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;nginx&#34;</span><span class="p">,</span> <span class="s2">&#34;-g&#34;</span><span class="p">,</span> <span class="s2">&#34;daemon off;&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></div><p>In this example:</p>
<ol>
<li><strong>Stage 1:</strong> Builds the Node.js application and creates a temporary image with all build dependencies.</li>
<li><strong>Stage 2:</strong> Creates a smaller final image using nginx:alpine and copies only the compiled application output, saving space.</li>
</ol>
<p>So basically we have two differences:</p>
<ol>
<li><strong>Without Multi-Stage Builds:</strong> An image including all build dependencies and artifacts can easily grow to several gigabytes, making it heavy and slow to distribute.</li>
<li><strong>With Multi-Stage Builds:</strong> Using intermediate stages results in a much smaller final image containing only whatâ€™s necessary to run the application. This can reduce the final image size to tens of megabytes.</li>
</ol>
<hr>
<ul>
<li><strong>Secure Base Images with Chainguard</strong></li>
</ul>
<p>Now that we know how to optimize our Dockerfiles, we should also address Docker image security, this time using Chainguard. Chainguard Images is a powerful extension that enhances image security effectively.</p>
<p><img src="https://media.licdn.com/dms/image/v2/D4E12AQEuRTRHiypjig/article-inline_image-shrink_1500_2232/article-inline_image-shrink_1500_2232/0/1693673715207?e=1758758400&amp;v=beta&amp;t=Gmbjzj2PAF4OsnV4QyeHwM6VpCnoxuA4-6RQ8OpJBls" alt="Article content"></p>
<p><a href="https://www.chainguard.dev/chainguard-images"  class="external-link" target="_blank" rel="noopener">https://www.chainguard.dev/chainguard-images</a></p>
<ul>
<li><strong>Chainguard Images</strong></li>
</ul>
<p>Chainguard images contain only what is necessary to build or run your application, providing on average an 80% reduction in size and fewer CVEs.</p>
<ol>
<li><strong>Daily-built images:</strong> Ensures that images are up-to-date and include available security patches.</li>
<li><strong>Signed by Sigstore/Cosign:</strong> Images are cryptographically signed to prove origin and provide tamper-proof guarantees.</li>
<li><strong>SBOM:</strong> Zeroed SBOMs certifying the provenance of all artifacts.</li>
</ol>
<hr>
<ul>
<li><strong>Using Docker History to View Layers</strong></li>
</ul>
<p>As we mentioned earlier about layers, an excellent command to inspect the layers of a Docker image is <strong>docker history</strong>.</p>
<p>How to use it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-zsh" data-lang="zsh"><span class="line"><span class="cl">docker <span class="nb">history</span> my-image:latest
</span></span></code></pre></div><p>This will display a list of all the layers that make up the image, along with their IDs, sizes, and corresponding instructions from the Dockerfile.</p>
<blockquote>
<p>[!tldr] The docker history command is useful for understanding how an image was built, which commands were executed in each layer, and the size of each layer. This can help optimize Docker image size and understand how images were created.</p></blockquote>
<h3 id="conclusion">
  <strong>Conclusion</strong>
  <a class="heading-link" href="#conclusion">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Using Multi-Stage Builds in a Dockerfile allows you to create smaller, more efficient images, significantly reducing the final image size. This is crucial for efficient container distribution and deployment. Additionally, using Chainguard images helps ensure Docker image security by verifying the origin and integrity of each layer.</p>
<p>By combining these practices, you can create Docker images that are both more secure and efficient, improving the performance and reliability of your containerized applications.</p>

      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    Â©  2019 -
     2025  Valdir Junior    <a></a> <a></a> 
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.js"></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
